# =============================================================================
# Quality Scale tracking for Kwikset Smart Locks integration
# =============================================================================
# https://developers.home-assistant.io/docs/core/integration-quality-scale
# 
# This integration targets PLATINUM tier compliance.
# Current Status: GOLD (complete) | PLATINUM (3/4 - blocked by upstream)
# 
# Last updated: 2025-11-26
# Maintainer: @explosivo22
# =============================================================================

rules:
  # =============================================================================
  # BRONZE TIER REQUIREMENTS (9/9 complete) ‚úÖ
  # =============================================================================
  # Bronze tier represents the minimum quality standard for Home Assistant
  # integrations. All Bronze requirements MUST be met for any integration.
  # =============================================================================
  
  config_flow:
    status: done
    comment: |
      Full UI-based setup via config_flow.py with:
      - Credential collection (email/password) in async_step_user
      - MFA challenge handling (SMS and authenticator app) in async_step_mfa
      - Home selection for multi-home accounts in async_step_select_home
      - Reauthentication flow in async_step_reauth_confirm
      - Reconfigure flow in async_step_reconfigure for device discovery
      - Options flow for polling interval (15-60 seconds)
      Location: custom_components/kwikset-ha/config_flow.py
  
  test_before_setup:
    status: done
    comment: |
      async_setup_entry in __init__.py validates before platform setup:
      1. Calls async_renew_access_token() to validate/refresh tokens
      2. Fetches user info via client.user.get_info() to verify auth
      3. Raises ConfigEntryAuthFailed on auth errors
      4. Raises ConfigEntryNotReady on transient network errors
      Only proceeds to platform setup if all validation passes.
      Location: custom_components/kwikset-ha/__init__.py:async_setup_entry
  
  unique_config_entry:
    status: done
    comment: |
      Uses async_set_unique_id(home_id) in config_flow.py to prevent
      duplicate entries per Kwikset home. Each home is a separate config
      entry with unique_id = home_id from the Kwikset API.
      Location: custom_components/kwikset-ha/config_flow.py:async_step_select_home
  
  has_entity_name:
    status: done
    comment: |
      KwiksetEntity base class sets _attr_has_entity_name = True.
      All entities use translation_key for names (Lock, Battery, LED, Audio, Secure Screen).
      HA auto-prefixes device name to create full entity name.
      Location: custom_components/kwikset-ha/entity.py:KwiksetEntity
  
  entity_unique_id:
    status: done
    comment: |
      Format: {device_id}_{entity_type}
      Examples: "device_123_lock", "device_123_battery", "device_123_led_switch"
      Set in KwiksetEntity.__init__() via self._attr_unique_id
      Location: custom_components/kwikset-ha/entity.py:KwiksetEntity.__init__
  
  docs_high_level_description:
    status: done
    comment: |
      README.md provides comprehensive overview:
      - Integration purpose and features
      - Supported devices and product lines
      - Connection mode (cloud polling)
      - Key capabilities (lock/unlock, battery, settings)
      Location: README.md "Features" and intro sections
  
  docs_installation_instructions:
    status: done
    comment: |
      README.md includes detailed installation steps:
      - HACS installation (recommended) with My Home Assistant button
      - Manual installation with directory structure
      - Configuration steps with My Home Assistant button
      - Warning about manual installation update notifications
      Location: README.md "Installation" and "Configuration" sections
  
  appropriate_polling:
    status: done
    comment: |
      Polling interval is user-configurable via options flow:
      - Default: 30 seconds (DEFAULT_REFRESH_INTERVAL in const.py)
      - Range: 15-60 seconds via NumberSelector slider
      - Each coordinator uses update_interval from entry.options
      - Can be changed without reloading integration
      Location: custom_components/kwikset-ha/const.py, config_flow.py:KwiksetOptionsFlow
  
  brands:
    status: exempt
    comment: |
      Custom component not included in Home Assistant core.
      Brand registration is only required for core integrations.
      Uses manifest.json for integration metadata instead.

  # =============================================================================
  # SILVER TIER REQUIREMENTS (8/8 complete) ‚úÖ
  # =============================================================================
  # Silver tier ensures proper lifecycle management, error handling,
  # and user experience improvements.
  # =============================================================================
  
  config_entry_unloading:
    status: done
    comment: |
      async_unload_entry in __init__.py properly unloads:
      - All platforms via async_unload_platforms(entry, PLATFORMS)
      - Update listeners registered via entry.async_on_unload()
      - Periodic device discovery timer
      Returns True on successful unload.
      Location: custom_components/kwikset-ha/__init__.py:async_unload_entry
  
  reauthentication_flow:
    status: done
    comment: |
      Complete reauth flow in config_flow.py:
      - async_step_reauth: Entry point triggered by ConfigEntryAuthFailed
      - async_step_reauth_confirm: Credential re-entry with MFA support
      - async_step_mfa_reauth: MFA verification during reauth
      - Uses async_update_reload_and_abort for seamless token update
      Location: custom_components/kwikset-ha/config_flow.py
  
  log_when_unavailable:
    status: done
    comment: |
      Error logging via DataUpdateCoordinator pattern:
      - Coordinator raises UpdateFailed with error message on API failures
      - HA logs these automatically at appropriate levels
      - LOGGER.error/warning/debug used throughout for different severities
      - Entity availability reflects coordinator.last_update_success
      Location: custom_components/kwikset-ha/device.py:_api_call_with_retry
  
  parallel_updates:
    status: done
    comment: |
      PARALLEL_UPDATES = 1 defined in const.py and imported in all platforms.
      This limits concurrent API calls per platform to prevent:
      - Rate limiting from Kwikset cloud
      - Overwhelming the device
      - Race conditions in state updates
      Location: custom_components/kwikset-ha/const.py, lock.py, sensor.py, switch.py
  
  stale_devices:
    status: done
    comment: |
      Complete stale device tracking in __init__.py:
      - KwiksetRuntimeData.known_devices tracks discovered device IDs
      - _async_update_devices() runs every 5 minutes
      - Compares current API devices vs known_devices
      - Removed devices are cleaned up via device_registry.async_update_device(remove_config_entry_id=...)
      - Coordinators are also removed from runtime_data.devices
      Implementation details:
        1. Fetch current devices from API
        2. Calculate removed_device_ids = known_devices - current_device_ids
        3. For each removed device:
           - Remove from device registry
           - Delete coordinator from devices dict
           - Discard from known_devices set
      Location: custom_components/kwikset-ha/__init__.py:_async_update_devices
  
  entity_unavailable:
    status: done
    comment: |
      KwiksetEntity.available property returns coordinator.last_update_success.
      This ensures entities show as unavailable when:
      - API calls fail
      - Network connectivity issues
      - Authentication problems
      HA automatically tracks this and shows unavailable state in UI.
      Location: custom_components/kwikset-ha/entity.py:KwiksetEntity.available
  
  action_exceptions:
    status: done
    comment: |
      Proper exception handling throughout:
      - ConfigEntryAuthFailed raised for authentication failures (triggers reauth)
      - HomeAssistantError with translation_key for user-facing errors
      - UpdateFailed for coordinator polling failures
      - Retry logic in _api_call_with_retry before raising
      Location: custom_components/kwikset-ha/device.py, lock.py, switch.py
  
  common_modules:
    status: exempt
    comment: |
      No shared modules with other integrations.
      This rule applies when multiple integrations share common code
      that should be extracted to a helper library.

  # =============================================================================
  # GOLD TIER REQUIREMENTS (9/9 complete) ‚úÖ
  # =============================================================================
  # Gold tier represents a high-quality integration with excellent
  # user experience, documentation, and maintainability.
  # =============================================================================
  
  discovery:
    status: exempt
    comment: |
      Cloud-based integration - devices cannot be discovered locally.
      Kwikset locks require cloud authentication and don't expose
      local network APIs. Discovery rules don't apply to cloud-only integrations.
  
  reconfiguration_flow:
    status: done
    comment: |
      async_step_reconfigure in config_flow.py allows users to:
      - Trigger device discovery without re-entering credentials
      - Refresh tokens and reload the integration
      - Pick up newly added devices
      Accessible via integration options in HA UI.
      Location: custom_components/kwikset-ha/config_flow.py:async_step_reconfigure
  
  dynamic_devices:
    status: done
    comment: |
      Full dynamic device discovery implementation:
      - 5-minute periodic polling via async_track_time_interval
      - _async_update_devices() checks for new/removed devices
      - New devices get coordinators created and first_refresh called
      - Bus event "{DOMAIN}_new_device" notifies platforms
      - Platforms listen for event and call _async_add_new_devices()
      - No integration reload required for new devices
      Location: custom_components/kwikset-ha/__init__.py:_async_update_devices
  
  integration_owner:
    status: done
    comment: |
      Maintainer clearly identified:
      - manifest.json: "codeowners": ["@explosivo22"]
      - Repository has CODEOWNERS file
      - Issues are actively managed
      Location: custom_components/kwikset-ha/manifest.json
  
  docs_use_cases:
    status: done
    comment: |
      README.md "Use Cases & Automations" section includes:
      - Auto-lock at night automation
      - Low battery alert automation
      - Welcome home unlock automation
      - Lock status dashboard card
      - Guest access notification automation
      Each with complete YAML examples.
      Location: README.md "Use Cases & Automations" section
  
  docs_supported_devices:
    status: done
    comment: |
      README.md "Supported Devices" section includes:
      - Product line table (Halo, Aura, Obsidian, Premis, SmartCode)
      - Model specifics and features
      - Compatibility note about Kwikset app
      - Verified working models list
      Location: README.md "Supported Devices" section
  
  docs_troubleshooting:
    status: done
    comment: |
      README.md "Troubleshooting" section includes:
      - Common issues with causes and solutions
      - Cannot connect, auth errors, MFA issues
      - No homes, missing devices, unavailable state
      - Action failures
      - Debug logging configuration
      - Getting help guidance
      Location: README.md "Troubleshooting" section
  
  diagnostics:
    status: done
    comment: |
      diagnostics.py implements async_get_config_entry_diagnostics:
      - Collects entry data, options, and device information
      - Uses async_redact_data for sensitive info:
        - Tokens (access, refresh)
        - IDs (home, device, user, serial)
        - PII (email, names)
      - Includes device state, model, firmware, battery, settings
      Location: custom_components/kwikset-ha/diagnostics.py
  
  test_coverage:
    status: done
    comment: |
      Comprehensive pytest suite in tests/ directory:
      - test_config_flow.py: All config flow steps and error paths
      - test_init.py: Setup, unload, migrations, device discovery
      - test_device.py: Coordinator, token refresh, retry logic
      - test_entity.py: Base entity, unique_id, device_info
      - test_lock.py: Lock/unlock actions and states
      - test_sensor.py: Battery sensor
      - test_switch.py: LED, audio, secure screen switches
      - test_diagnostics.py: Diagnostic data and redaction
      - conftest.py: Shared fixtures and mock data
      Location: tests/

  # =============================================================================
  # PLATINUM TIER REQUIREMENTS (3/4 complete) üîÑ
  # =============================================================================
  # Platinum tier represents the highest quality standard with strict
  # typing, proper async patterns, and full HA integration best practices.
  # =============================================================================
  
  async_dependency:
    status: done
    comment: |
      aiokwikset library (requirement in manifest.json) is fully async:
      - All API methods use async/await
      - Uses aiohttp for HTTP requests
      - No blocking I/O operations
      - Compatible with HA's async event loop
      Location: manifest.json requirements, all API calls in device.py
  
  inject_websession:
    status: todo
    comment: |
      BLOCKER: Cannot achieve without upstream library changes.
      
      Current state:
        - aiokwikset library creates its own aiohttp.ClientSession internally
        - No parameter to pass in an existing session
      
      Required changes:
        - aiokwikset needs constructor parameter for session injection
        - Would use async_get_clientsession(hass) from HA helpers
        - Track: https://github.com/explosivo22/aiokwikset/issues
      
      Benefits of injection:
        - Shares HA's connection pool
        - Proper SSL certificate handling
        - Automatic session cleanup
        - Better resource management
      
      This is the ONLY blocker for Platinum tier compliance.
  
  strict_typing:
    status: done
    comment: |
      Full strict typing implementation:
      - py.typed marker in package directory
      - Type annotations on all public APIs
      - TypedDict for coordinator data (KwiksetDeviceData)
      - Final types in const.py for immutable constants
      - ConfigFlowResult return types on all flow methods
      - Generic type parameters (DataUpdateCoordinator[KwiksetDeviceData])
      - TYPE_CHECKING blocks for import-only types
      Location: All Python files, custom_components/kwikset-ha/py.typed
  
  runtime_data:
    status: done
    comment: |
      Modern runtime_data pattern fully implemented:
      - KwiksetRuntimeData dataclass holds all runtime state
      - Fields: client (API), devices (dict), known_devices (set)
      - Type alias: type KwiksetConfigEntry = ConfigEntry[KwiksetRuntimeData]
      - Access via entry.runtime_data instead of hass.data[DOMAIN]
      - Provides type safety and autocomplete in IDEs
      - Automatic cleanup on entry unload
      Location: custom_components/kwikset-ha/__init__.py

  # =============================================================================
  # ADDITIONAL QUALITY IMPROVEMENTS (beyond standard tiers) ‚≠ê
  # =============================================================================
  # These are quality improvements that go beyond the standard requirements
  # and demonstrate best practices for integration development.
  # =============================================================================
  
  proactive_token_refresh:
    status: done
    comment: |
      JWT tokens are refreshed BEFORE expiry to prevent auth failures:
      - TOKEN_REFRESH_BUFFER_SECONDS = 300 (5 minutes before expiry)
      - _parse_token_expiry() decodes JWT to get exp claim
      - _is_token_expiring_soon() checks if refresh needed
      - _ensure_valid_token() called before every API operation
      - Refreshed tokens persisted to config entry for restarts
      Location: custom_components/kwikset-ha/device.py
  
  retry_logic:
    status: done
    comment: |
      All API operations have retry logic for transient failures:
      - MAX_RETRY_ATTEMPTS = 3
      - RETRY_DELAY_SECONDS = 2 (between retries)
      - _api_call_with_retry() wrapper handles retries
      - Distinguishes auth errors (raise immediately) from transient errors
      - Logs retry attempts for debugging
      Location: custom_components/kwikset-ha/device.py:_api_call_with_retry
  
  token_persistence:
    status: done
    comment: |
      Tokens survive Home Assistant restarts:
      - Stored in config_entry.data (CONF_ACCESS_TOKEN, CONF_REFRESH_TOKEN)
      - Updated via hass.config_entries.async_update_entry()
      - Refreshed on every startup in async_setup_entry
      - Also refreshed proactively by coordinator
      Location: custom_components/kwikset-ha/__init__.py, device.py
  
  comprehensive_documentation:
    status: done
    comment: |
      Extensive documentation throughout the codebase:
      - Architectural overview in copilot-instructions.md
      - Module docstrings explaining purpose and patterns
      - Class docstrings with usage examples
      - Method docstrings with Args/Returns/Raises
      - Inline comments for complex logic
      - README.md with complete user documentation
      - CHANGELOG.md with version history
      - quality_scale.yaml with compliance tracking
      Location: All files, .github/instructions/, README.md, CHANGELOG.md
